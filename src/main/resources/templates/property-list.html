<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Property List</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: lightsteelblue;
      margin: 10px;
    }

    h1 {
      text-align: center;
      color: brown;
      margin-bottom: 15px;
    }

    .search-bar {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 10px;
      margin-bottom: 20px;
    }

    .search-bar input, .search-bar select, .search-bar button {
      padding: 8px;
      border-radius: 5px;
      border: 1px solid #ccc;
      font-size: 0.9rem;
    }

    .search-bar button {
      background-color: #1976d2;
      color: white;
      cursor: pointer;
      font-weight: bold;
      border: none;
      transition: background-color 0.3s;
    }

    .search-bar button:hover {
      background-color: #1565c0;
    }

    .property-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 15px;
    }

    .property-card {
      background: #fff;
      border-radius: 10px;
      padding: 15px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
      transition: transform 0.2s;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
    }

    .property-card:hover {
      transform: translateY(-5px);
    }

    .property-card img {
      width: 100%;
      height: 180px;
      object-fit: cover;
      border-radius: 5px;
      margin-bottom: 10px;
    }

    .property-card h3 {
      margin: 5px 0;
      color: #333;
      font-size: 1.1rem;
    }

    .property-card p {
      margin: 5px 0;
      color: #555;
      font-size: 0.95rem;
    }

    .property-card button, .property-card a {
      margin-right: 5px;
      margin-top: 5px;
      padding: 6px 12px;
      border-radius: 5px;
      cursor: pointer;
      text-decoration: none;
      color: white;
      border: none;
      font-size: 0.9rem;
    }

    .property-card button { background-color: crimson; }
    .property-card a { background-color: #007bff; }

    .property-card button:hover,
    .property-card a:hover { opacity: 0.85; }

    @media(max-width: 480px) {
      .search-bar { flex-direction: column; gap: 8px; }
      .property-card img { height: 150px; }
    }
  </style>
</head>
<body>
  <h1>Properties</h1>

  <div class="search-bar">
    <input id="qKeyword" placeholder="Keyword">
    <input id="qLocation" placeholder="Location">
    <input id="qMinPrice" placeholder="Min price" type="number">
    <input id="qMaxPrice" placeholder="Max price" type="number">
    <select id="qType">
      <option value="">All</option>
      <option value="SALE">SALE</option>
      <option value="RENT">RENT</option>
    </select>
    <button id="btnSearch">Search</button>
    <button id="btnClear">Clear</button>
  </div>

  <div id="list" class="property-grid"></div>

  <script>
    const token = localStorage.getItem('token');
    let currentEmail = null;
    let currentRole = null;

    if(token){
      try {
        const payload = JSON.parse(atob(token.split('.')[1]));
        currentEmail = payload.sub;
        currentRole = payload.role || payload.roles || null;
      } catch {}
    }

    async function loadApproved(){
      try {
        const res = await fetch('/api/properties/approved');
        const props = await res.json();
        render(props);
      } catch {
        document.getElementById('list').innerText = 'Error loading properties';
      }
    }

    function render(props){
      const container = document.getElementById('list');
      if(!props.length) { container.innerHTML = '<p>No properties found.</p>'; return; }
      container.innerHTML = props.map(p => `
        <div class="property-card">
          <img src="${p.imageUrl || 'https://via.placeholder.com/300x200?text=No+Image'}" alt="${p.title}">
          <h3>${p.title}</h3>
          <p>${p.description || ''}</p>
          <p>Type: ${p.type} | Price: â‚¹${p.price} | Location: ${p.location}</p>
          <a href="/webpages/properties/${p.id}">Details</a>
          ${ownerActions(p)}
        </div>
      `).join('');
    }

    function ownerActions(p){
      const isOwner = currentEmail && p.owner?.email === currentEmail;
      const isAdmin = currentRole && (currentRole === 'ROLE_ADMIN' || currentRole === 'ADMIN');
      if(isOwner || isAdmin){
        return `<button onclick="editProp(${p.id})">Edit</button>
                <button onclick="deleteProp(${p.id})">Delete</button>`;
      }
      return '';
    }

    function editProp(id){ window.location.href = `/webpages/properties/edit/${id}`; }

    async function deleteProp(id){
      if(!confirm('Delete this property?')) return;
      try {
        const res = await fetch(`/api/properties/delete/${id}?email=${encodeURIComponent(currentEmail)}`, {
          method: 'DELETE',
          headers: { 'Authorization': 'Bearer ' + token }
        });
        if(res.ok){ alert('Deleted'); loadApproved(); }
        else { const txt = await res.text(); alert('Failed: ' + txt); }
      } catch(e){ console.error(e); }
    }

    document.getElementById('btnSearch').addEventListener('click', async () => {
      const params = new URLSearchParams();
      const kw = document.getElementById('qKeyword').value;
      const loc = document.getElementById('qLocation').value;
      const min = document.getElementById('qMinPrice').value;
      const max = document.getElementById('qMaxPrice').value;
      const type = document.getElementById('qType').value;

      if(kw) params.append('keyword', kw);
      if(loc) params.append('location', loc);
      if(min) params.append('minPrice', min);
      if(max) params.append('maxPrice', max);
      if(type) params.append('type', type);

      try {
        const res = await fetch('/api/properties/search?' + params.toString());
        const props = await res.json();
        render(props);
      } catch(e){ console.error(e); }
    });

    document.getElementById('btnClear').addEventListener('click', () => {
      ['qKeyword','qLocation','qMinPrice','qMaxPrice','qType'].forEach(id => document.getElementById(id).value='');
      loadApproved();
    });

    loadApproved();
  </script>
</body>
</html>
